# Сервис геолокации

## Описание

Этот сервис предоставляет API для определения географического положения по координатам и поиска ближайших городов.

## Установка и запуск

### Предварительные требования

*   Python 3.11
*   Установленная и настроенная база данных PostgreSQL
*   `make` (опционально, для упрощения запуска)
*   Docker (опционально, для упрощения запуска PostgreSQL)

### Развертывание

1.  **Клонирование репозитория (если применимо):**

    ```
    git clone https://github.com/Temmmmmo/geocity_api
    cd geocity_api
    ```

2.  **Создание и активация виртуального окружения:**

    ```
    python3 -m venv venv
    source ./venv/bin/activate  # macOS и Linux
    venv\Scripts\activate  # Windows
    ```

3.  **Установка зависимостей:**

    ```
    pip install -r requirements.txt
    ```

4.  **Настройка базы данных PostgreSQL:**

    *   Убедитесь, что у вас установлена и запущена база данных PostgreSQL.
    *   Создайте базу данных для вашего проекта (если это необходимо).
    *   Настройте параметры подключения к базе данных (имя пользователя, пароль, хост, имя базы данных) в переменных окружения.
    *   Выполните миграции базы данных с помощью Alembic:

        ```
        alembic upgrade head
        ```

5.  **Настройка переменных окружения:**

    Создайте файл `.env` в корне вашего проекта и добавьте в него следующие переменные:

    ```
    DB_DSN=postgresql://user:password@host:port/database
    YANDEX_GEOCODER_API_KEY=YOUR_API_KEY
    YANDEX_GEOCODER_BASE_URL=https://geocode-maps.yandex.ru/1.x  # необязательно
    YANDEX_GEOCODER_LANGUAGE=ru_RU  # необязательно
    NEAREST_CITY_COUNT=2  # необязательно
    ```

    *   `DB_DSN`: Строка подключения к базе данных PostgreSQL в формате SQLAlchemy. Замените `user`, `password`, `host`, `port` и `database` на соответствующие значения для вашей базы данных.
    *   `YANDEX_GEOCODER_API_KEY`: API-ключ для сервиса Яндекс.Геокодер.
        *   **Как получить YANDEX_GEOCODER_API_KEY:**
            1.  Перейдите на сайт [Яндекс.Карт для бизнеса](https://yandex.ru/dev/maps/).
            2.  Авторизуйтесь или зарегистрируйтесь.
            3.  Создайте новый API-ключ для сервиса Геокодер.  Убедитесь, что в настройках ключа разрешено использование Геокодера.
            4.  Скопируйте полученный API-ключ и вставьте его в файл `.env`.
    *   `YANDEX_GEOCODER_BASE_URL`: Базовый URL для API Яндекс.Геокодер.  Обычно нет необходимости изменять это значение. По умолчанию `https://geocode-maps.yandex.ru/1.x`
    *   `YANDEX_GEOCODER_LANGUAGE`: Язык, на котором будут возвращаться результаты геокодирования.  По умолчанию `ru_RU` (русский).
    *   `NEAREST_CITY_COUNT`: Количество ближайших городов, возвращаемых при запросе `GET /city`. По умолчанию 2.

6.  **Запуск приложения:**

    ```
    python -m backend
    ```
    После запуска приложения, Swagger UI будет доступен по адресу `http://localhost:<port>/docs`.

## Запуск с использованием Makefile (опционально)

Для упрощения процесса запуска и настройки можно использовать `Makefile`.  Убедитесь, что у вас установлен `make`.

*   **Создание и настройка окружения:**

    ```
    make configure
    ```
    Эта команда выполнит создание виртуального окружения, установку зависимостей (requirements.txt и requirements.dev.txt).

*   **Запуск базы данных PostgreSQL (с использованием Docker):**

    ```
    make db
    ```
    Эта команда запустит PostgreSQL в Docker-контейнере (убедитесь, что у вас установлен и запущен Docker).  **ВНИМАНИЕ:** Этот способ использует `POSTGRES_HOST_AUTH_METHOD=trust` для упрощения, что не рекомендуется для production-окружений.

*   **Выполнение миграций базы данных:**

    ```
    make migrate
    ```
    Эта команда выполнит миграции Alembic для создания или обновления схемы базы данных.

*   **Запуск приложения:**

    ```
    make run
    ```
    Эта команда запустит приложение с использованием `uvicorn`, перезагрузкой при изменении кода и конфигурацией логирования из файла `logging_dev.conf`.

## Использование API

Все ручки API сгруппированы под тегом "City" и имеют префикс `/city`.

*   **Создание города:** `POST /city`
    ```
    POST /city?city_name={название_города}
    ```
    *   Описание: Создает город с его координатами, взятыми из YandexGeocoderAPI, в базе данных.
    *   Обязательный параметр: `city_name` - название города.
    *   Пример запроса:
        ```
        POST /city?city_name=Москва
        ```
    *   Пример успешного ответа (200 OK):
        ```
        {
            "id": 1,
            "name": "Москва",
            "longitude": 37.617698,
            "latitude": 55.755826
        }
        ```

*   **Получение списка городов:** `GET /city`
    ```
    GET /city?longitude={долгота}&latitude={широта}
    ```
    *   Описание: Возвращает все города, имеющиеся в базе. Если одновременно переданы query-параметры `longitude` (Долгота) и `latitude` (Широта), то вернется указанное в `NEAREST_CITY_COUNT` (по умолчанию 2) ближайших к этим координатам городов.
    *   Пример запроса (получение всех городов):
        ```
        GET /city
        ```
    *   Пример запроса (получение ближайших городов):
        ```
        GET /city?longitude=30.3&latitude=60.0
        ```
    *   Пример успешного ответа при запросе с одновременной передачи координат (200 OK):
        ```
        [
            {
                "id": 1,
                "name": "Санкт-Петербург",
                "longitude": 30.3,
                "latitude": 60.0,
                "distance": 0.0
            },
            {
                "id": 2,
                "name": "Москва",
                "longitude": 37.6,
                "latitude": 55.7,
                "distance": 634.5
            }
        ]
        ```

*   **Получение информации о городе по ID:** `GET /city/{city_id}`
    ```
    GET /city/{city_id}?longitude={долгота}&latitude={широта}
    ```
    *   Описание: Возвращает город по его идентификатору в базе данных. Если одновременно переданы параметры `longitude` и `latitude`, то также вернет расстояние от данной точки до данного города.
    *   Параметры:
        *   `city_id` (path):  Идентификатор города.
    *   Пример запроса:
        ```
        GET /city/1?longitude=30.0&latitude=60.0
        ```
    *   Пример успешного ответа (200 OK):
        ```
        {
            "id": 1,
            "name": "Санкт-Петербург",
            "longitude": 30.3,
            "latitude": 60.0,
            "distance": 33.3
        }
        ```

*   **Удаление города:** `DELETE /city/{city_id}`
    ```
    DELETE /city/{city_id}
    ```
    *   Описание: Удаляет город из базы данных по его id.
    *   Параметры:
        *   `city_id` (path): Идентификатор города.
    *   Пример запроса:
        ```
        DELETE /city/1
        ```
    *   Пример успешного ответа (200 OK):
        ```
        {
            "status": "Success",
            "message": "City with id 1 has been deleted from database",
            "ru": "Город с идентификатором 1 был удален из базы данных"
        }
        ```
## Возможные ошибки API и способы их решения

*   **Ошибка 404 Not Found:**

    *   **При создании города (`POST /city`):**  Город с указанным названием не найден в Yandex Geocoder API.  Убедитесь, что название города написано правильно.
    *   **При получении города по ID (`GET /city/{city_id}`):** Город с указанным ID не существует в базе данных.  Проверьте, что ID указан правильно.
    *   **При удалении города (`DELETE /city/{city_id}`):** Город с указанным ID не существует в базе данных. Проверьте, что ID указан правильно.

*   **Ошибка 409 Conflict:**

    *   **При создании города (`POST /city`):** Город с таким названием или координатами уже существует в базе данных.

*   **Ошибка 400 Bad Request:**

    *   **При получении списка городов (`GET /city`) или информации о городе по ID (`GET /city/{city_id}`):**  Переданы параметры `longitude` или `latitude` по отдельности.  Необходимо передавать оба параметра одновременно.

*   **Ошибка 500 Internal Server Error:**

    *   Ошибка при подключении к базе данных.  Проверьте переменную окружения `DB_DSN` и убедитесь, что база данных запущена.
    *   Ошибка при обращении к Yandex Geocoder API.  Проверьте переменную окружения `YANDEX_GEOCODER_API_KEY` и убедитесь, что API-ключ действителен.  Проверьте доступность сервиса Яндекс.Геокодер.

*   **Другие ошибки:**

    *   Проверьте логи приложения на наличие более подробной информации об ошибке.
    *   Убедитесь, что все необходимые переменные окружения установлены.
    *   Проверьте, что база данных PostgreSQL запущена и доступна.
    *   Попробуйте перезапустить приложение.

## Тестирование

Для запуска тестов необходимо установить `pytest`. Обычно это делается вместе с установкой зависимостей разработки (через `requirements.dev.txt`).

Перейдите в корневую директорию проекта и выполните следующую команду:
```
pytest tests
```

Эта команда запустит все тесты, расположенные в директории `tests`.
        
